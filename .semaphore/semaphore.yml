version: v1.0
name: Learning Semaphore
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Create docker image
    task:
      jobs:
        - name: Build and publish
          commands:
            - checkout
            - docker login --username $DOCKER_USERNAME --password $DOCKER_PASSWORD
            - 'docker build --target node --tag kwanzek/test-semaphore:kw-test . '
            - 'docker push kwanzek/test-semaphore:kw-test'
      secrets:
        - name: docker-password
        - name: docker-user-name
  - name: TESTS
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
        containers:
          - name: main
            image: 'kwanzek/test-semaphore:kw-test'
      jobs:
        - name: Run node tests
          commands:
            - npm test
execution_time_limit:
  minutes: 15
